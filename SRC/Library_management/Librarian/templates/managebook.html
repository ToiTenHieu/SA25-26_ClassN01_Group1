{% extends "librarian_dashboard.html" %} {% block content %}
<!-- Quáº£n LÃ½ SÃ¡ch Section -->
{% include "manageuser.html" %}
<!-- Quáº£n LÃ½ MÆ°á»£n/Tráº£ Section -->
{% include "manageBorrow.html" %}
<div
  id="quanLySach"
  class="section bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-8 mb-8 card-hover border border-white/20"
>
  <div class="flex justify-between items-center mb-8">
    <div class="flex items-center space-x-4">
      <div
        class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl flex items-center justify-center"
      >
        <span class="text-white text-xl">ğŸ“š</span>
      </div>
      <h2
        class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent"
      >
        Manage Books
      </h2>
    </div>
    <button
      onclick="openAddBookModal()"
      class="btn-primary text-white px-8 py-4 rounded-2xl font-bold flex items-center space-x-3 shadow-lg"
    >
      <span class="text-xl">â•</span>
      <span>Add New Book</span>
    </button>
  </div>

  <!-- Bá»™ lá»c thá»ƒ loáº¡i vá»›i thiáº¿t káº¿ Ä‘áº¹p -->
  <div class="mb-8">
    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
      <span
        class="w-8 h-8 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center mr-3"
      >
        <span class="text-white text-sm">ğŸ·ï¸</span>
      </span>
      Filter by Category
    </h3>
    <div class="flex flex-wrap gap-3">
      <button
        onclick="filterBooks('all')"
        class="category-btn filter-btn bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-300"
      >
        âœ¨ All Categories
      </button>
      <button
        onclick="filterBooks('cong-nghe')"
        class="category-btn filter-btn bg-white text-gray-700 px-6 py-3 rounded-xl font-semibold shadow-md hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:text-white transition-all duration-300 border border-gray-200"
      >
        ğŸ’» Technology
      </button>
      <button
        onclick="filterBooks('toan-hoc')"
        class="category-btn filter-btn bg-white text-gray-700 px-6 py-3 rounded-xl font-semibold shadow-md hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:text-white transition-all duration-300 border border-gray-200"
      >
        ğŸ”¢ mathematics
      </button>
      <button
        onclick="filterBooks('ngoai-ngu')"
        class="category-btn filter-btn bg-white text-gray-700 px-6 py-3 rounded-xl font-semibold shadow-md hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:text-white transition-all duration-300 border border-gray-200"
      >
        ğŸŒ foreign language
      </button>
      <button
        onclick="filterBooks('van-hoc')"
        class="category-btn filter-btn bg-white text-gray-700 px-6 py-3 rounded-xl font-semibold shadow-md hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:text-white transition-all duration-300 border border-gray-200"
      >
        ğŸ“– literature
      </button>
      <button
        onclick="filterBooks('khoa-hoc')"
        class="category-btn filter-btn bg-white text-gray-700 px-6 py-3 rounded-xl font-semibold shadow-md hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:text-white transition-all duration-300 border border-gray-200"
      >
        ğŸ”¬ science
      </button>
      <button
        onclick="filterBooks('kinh-te')"
        class="category-btn filter-btn bg-white text-gray-700 px-6 py-3 rounded-xl font-semibold shadow-md hover:bg-gradient-to-r hover:from-blue-500 hover:to-purple-600 hover:text-white transition-all duration-300 border border-gray-200"
      >
        ğŸ’° economy
      </button>
    </div>
  </div>

  <!-- Danh sÃ¡ch sÃ¡ch vá»›i thiáº¿t káº¿ card Ä‘áº¹p -->
  <div
    class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-2xl p-6 border border-gray-100"
  >
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-gray-800 flex items-center">
        <span
          class="w-8 h-8 bg-gradient-to-r from-green-500 to-teal-600 rounded-lg flex items-center justify-center mr-3"
        >
          <span class="text-white text-sm">ğŸ“‹</span>
        </span>
        Book List
      </h3>
      <div class="bg-white px-4 py-2 rounded-xl shadow-md">
        <span class="text-gray-600">Total: </span>
        <span id="bookCount" class="font-bold text-blue-600 text-lg">0</span>
        <span class="text-gray-600"> books</span>
      </div>
    </div>

    <div
      id="bookList"
      class="max-h-96 overflow-y-auto scrollbar-hide space-y-4"
    >
      {% for book in books %}
      <div
        class="book-item book-card p-6 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 fade-in-up"
        data-category="{{ book.category|slugify }}"
      >
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <div class="flex items-center space-x-3 mb-3">
              <div class="w-16 h-24 overflow-hidden rounded-lg flex items-center justify-center bg-gray-100 flex-shrink-0">
                {% if book.cover_image %}
                  <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="w-full h-full object-cover">
                {% else %}
                  <span class="text-gray-400 text-2xl">ğŸ“š</span>
                {% endif %}
              </div>
              <h4 class="text-xl font-bold text-gray-800">{{ book.title }}</h4>
            </div>
            <div class="space-y-2 text-gray-600">
              <p class="flex items-center">
                <span class="mr-2">ğŸ‘¤</span> Author:
                <span class="font-semibold ml-1">{{ book.author }}</span>
              </p>
              <p class="flex items-center">
                <span class="mr-2">ğŸ·ï¸</span> Category:
                <span class="font-semibold ml-1">{{ book.category }}</span>
              </p>
              <p class="flex items-center">
                <span class="mr-2">ğŸ“¦</span> Quantity:
                <span class="font-semibold ml-1">{{ book.quantity }} books</span>
              </p>
              <p class="flex items-center">
                <span class="mr-2">ğŸ“…</span> Year of Publication:
                <span class="font-semibold ml-1">{{ book.year }}</span>
              </p>
            </div>
          </div>
          <div class="flex flex-col space-y-3 items-end">
            {% if book.quantity > 5 %}
            <span
              class="status-badge bg-green-100 text-green-800 px-4 py-2 rounded-xl text-sm font-bold"
              >âœ… In Stock</span
            >
            {% elif book.quantity > 0 %}
            <span
              class="status-badge bg-yellow-100 text-yellow-800 px-4 py-2 rounded-xl text-sm font-bold"
              >âš ï¸ Almost Out of Stock</span
            >
            {% else %}
            <span
              class="status-badge bg-red-100 text-red-800 px-4 py-2 rounded-xl text-sm font-bold"
              >âŒ Out of Stock</span
            >
            {% endif %}

            <div class="flex space-x-2">
              <button
                onclick="editBook({{ book.book_id }})"
                class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-300 text-sm font-semibold"
              >
                âœï¸ Edit
              </button>
              <button
                onclick="deleteBook({{ book.book_id }})"
                class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-300 text-sm font-semibold"
              >
                ğŸ—‘ï¸ Delete
              </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
<div
  id="editBookModal"
  class="fixed inset-0 modal-backdrop bg-black/50 hidden z-50 flex items-center justify-center p-4"
>
  <div
    class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl mx-4 slide-in-right border border-white/20 flex flex-col max-h-[90vh] overflow-hidden"
  >
    <div
      class="bg-gradient-to-r from-yellow-400 to-orange-500 p-6 rounded-t-3xl"
    >
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div
            class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center"
          >
            <span class="text-white text-xl">âœï¸</span>
          </div>
          <h3 class="text-2xl font-bold text-white">Edit Book</h3>
        </div>
        <button
          onclick="closeEditBookModal()"
          class="text-white/80 hover:text-white text-3xl transition-colors"
        >
          Ã—
        </button>
      </div>
    </div>

    <form id="editBookForm" onsubmit="updateBook(event)" class="flex-1 overflow-y-auto p-8 space-y-6" enctype="multipart/form-data">
      <!-- hidden Ä‘á»ƒ lÆ°u id sÃ¡ch -->
      <input type="hidden" name="book_id" id="editBookId" />

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label
            class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
          >
            <span class="mr-2">ğŸ“–</span> Book Title
          </label>
          <input
            type="text"
            name="title"
            id="editTitle"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-300"
            required
          />
        </div>

        <div>
          <label
            class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
          >
            <span class="mr-2">ğŸ‘¤</span> Author
          </label>
          <input
            type="text"
            name="author"
            id="editAuthor"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-300"
            required
          />
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <label
            class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
          >
            <span class="mr-2">ğŸ·ï¸</span> Category
          </label>
          <select
            name="category"
            id="editCategory"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-300"
            required
          >
            <option value="">Choose category...</option>
            <option value="cong-nghe" data-label="CÃ´ng Nghá»‡">
              ğŸ’» Technology
            </option>
            <option value="toan-hoc" data-label="ToÃ¡n Há»c">ğŸ”¢ Mathematics</option>
            <option value="ngoai-ngu" data-label="Ngoáº¡i Ngá»¯">
              ğŸŒ Foreign Languages
            </option>
            <option value="van-hoc" data-label="VÄƒn Há»c">ğŸ“– Literature</option>
            <option value="khoa-hoc" data-label="Khoa Há»c">ğŸ”¬ Science</option>
            <option value="kinh-te" data-label="Kinh Táº¿">ğŸ’° Economics</option>
          </select>
        </div>

        <div>
          <label
            class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
          >
            <span class="mr-2">ğŸ“¦</span> Quantity
          </label>
          <input
            type="number"
            name="quantity"
            id="editQuantity"
            min="0"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-300"
            required
          />
        </div>
      </div>

      <div>
        <label
          class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
        >
          <span class="mr-2">ğŸ“…</span> Publication Year
        </label>
        <input
          type="number"
          name="year"
          id="editYear"
          min="1900"
          max="2024"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-300"
          required
        />
      </div>

      <div>
        <label
          class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
        >
          <span class="mr-2">ğŸ“</span> Description (Optional)
        </label>
        <textarea
          name="description"
          id="editDescription"
          rows="4"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-300 resize-none"
        ></textarea>
      </div>

      <div>
        <label
          class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
        >
          <span class="mr-2">ğŸ–¼ï¸</span> Book Cover Image (Optional)
        </label>
        <div class="mb-3">
          <img id="editCoverImagePreview" src="" alt="Cover preview" class="hidden w-24 h-36 sm:w-32 sm:h-48 object-cover rounded-lg border-2 border-gray-200 mb-2">
          <p id="editCurrentCover" class="text-sm text-gray-600 mb-2"></p>
        </div>
        <input
          type="file"
          name="cover_image"
          id="editCoverImage"
          accept="image/*"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-300"
        />
        <p class="text-xs text-gray-500 mt-2">Chá»n áº£nh má»›i Ä‘á»ƒ thay Ä‘á»•i bÃ¬a sÃ¡ch (JPG, PNG, etc.)</p>
      </div>

      <div>
        <label
          class="block text-sm font-bold text-gray-700 mb-3 flex items-center"
        >
          <span class="mr-2">ğŸ“Œ</span> Status
        </label>
        <select
          name="status"
          id="editStatus"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all duration-300"
        >
          <option value="available">âœ… Available</option>
          <option value="unavailable">âŒ Unavailable</option>
        </select>
      </div>

      <div class="flex space-x-4 pt-6">
        <button
          type="submit"
          class="flex-1 bg-gradient-to-r from-yellow-500 to-orange-500 text-white py-4 px-6 rounded-xl font-bold text-lg shadow-lg"
        >
          ğŸ’¾ Save Changes
        </button>
        <button
          type="button"
          onclick="closeEditBookModal()"
          class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white py-4 px-6 rounded-xl hover:shadow-lg transition-all duration-300 font-bold text-lg"
        >
          âŒ Cancel
        </button>
      </div>
    </form>
  </div>
</div>

{% include "bookstatistics.html" %}

<script>
  // Map tá»« emoji â†’ slug
  const categoryMap = {
    "ğŸ’» Technology": "cong-nghe",
    "ğŸ”¢ Mathematics": "toan-hoc",
    "ğŸŒ Foreign Language": "ngoai-ngu",
    "ğŸ“– Literature": "van-hoc",
    "ğŸ”¬ Science": "khoa-hoc",
    "ğŸ’° Economics": "kinh-te",
  };

  // Map ngÆ°á»£c tá»« slug â†’ emoji
  const reverseCategoryMap = Object.fromEntries(
    Object.entries(categoryMap).map(([key, value]) => [value, key])
  );

  // Má»Ÿ modal vÃ  load dá»¯ liá»‡u sÃ¡ch
  function editBook(bookId) {
    console.log("Book ID nháº­n Ä‘Æ°á»£c:", bookId);

    fetch(`/librarian/api/books/${bookId}/`) // endpoint GET chi tiáº¿t sÃ¡ch
      .then((response) => {
        if (!response.ok) throw new Error("Could not fetch book details");
        return response.json();
      })
      .then((data) => {
        // GÃ¡n dá»¯ liá»‡u vÃ o form
        document.getElementById("editBookId").value = data.book_id;
        document.getElementById("editTitle").value = data.title;
        document.getElementById("editAuthor").value = data.author;

        // âš™ï¸ Chuyá»ƒn tá»« emoji -> slug Ä‘á»ƒ hiá»ƒn thá»‹ Ä‘Ãºng option trong <select>
        document.getElementById("editCategory").value =
          categoryMap[data.category] || "";

        document.getElementById("editQuantity").value = data.quantity;
        document.getElementById("editYear").value = data.year || "";
        document.getElementById("editDescription").value =
          data.description || "";
        document.getElementById("editStatus").value =
          data.status || "available";

        // Hiá»ƒn thá»‹ áº£nh bÃ¬a hiá»‡n táº¡i náº¿u cÃ³
        const coverPreview = document.getElementById("editCoverImagePreview");
        const currentCoverText = document.getElementById("editCurrentCover");
        if (data.cover_image_url) {
          coverPreview.src = data.cover_image_url;
          coverPreview.classList.remove("hidden");
          currentCoverText.textContent = "BÃ¬a sÃ¡ch hiá»‡n táº¡i:";
        } else {
          coverPreview.classList.add("hidden");
          currentCoverText.textContent = "ChÆ°a cÃ³ bÃ¬a sÃ¡ch";
        }

        // Hiá»‡n modal
        document.getElementById("editBookModal").classList.remove("hidden");
      })
      .catch((error) => {
        console.error("Error fetching book details:", error);
        alert("Failed to load book details!");
      });
  }

  // ÄÃ³ng modal
  function closeEditBookModal() {
    document.getElementById("editBookModal").classList.add("hidden");
  }

  // Cáº­p nháº­t sÃ¡ch
  function updateBook(event) {
    event.preventDefault();

    const bookId = document.getElementById("editBookId").value;

    // Láº¥y slug tá»« form (vd: "van-hoc")
    const categorySlug = document.getElementById("editCategory").value;

    // âš™ï¸ Chuyá»ƒn slug -> emoji + tiáº¿ng Viá»‡t
    const categoryFull = reverseCategoryMap[categorySlug] || categorySlug;

    // build FormData from the form to allow file uploads
    const formEl = document.getElementById('editBookForm');
    const fd = new FormData(formEl);
    // override category with emoji/text
    fd.set('category', categoryFull);

    fetch(`/librarian/api/books/${bookId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body: fd,
    })
      .then((response) => {
        if (response.ok) {
          closeEditBookModal();
          location.reload();
        } else {
          alert('Cáº­p nháº­t tháº¥t báº¡i!');
        }
      })
      .catch((error) => {
        console.error('Error:', error);
        alert('There was an error updating the book!');
      });
  }

  // HÃ m láº¥y CSRF Token (náº¿u báº¡n Ä‘ang dÃ¹ng Django)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Hiá»ƒn thá»‹ preview khi chá»n file má»›i
  document.addEventListener('DOMContentLoaded', function() {
    const editCoverInput = document.getElementById("editCoverImage");
    if (editCoverInput) {
      editCoverInput.addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const preview = document.getElementById("editCoverImagePreview");
            if (preview) {
              preview.src = e.target.result;
              preview.classList.remove("hidden");
            }
          };
          reader.readAsDataURL(file);
        }
      });
    }
  });
</script>

<script>
  function deleteBook(bookId) {
  Swal.fire({
    title: "Delete Book?",
    text: "This book will be permanently deleted and cannot be recovered!",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#d33",
    cancelButtonColor: "#3085d6",
    confirmButtonText: "ğŸ—‘ï¸ Delete",
    cancelButtonText: "âŒ Cancel",
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/librarian/api/books/${bookId}/`, {
        method: "DELETE",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
      })
        .then((response) => {
          if (!response.ok) throw new Error("Could not delete book");
          return response.json();
        })
        .then((data) => {
          Swal.fire({
            title: "Deleted!",
            text: data.message || "Book has been deleted successfully.",
            icon: "success",
            confirmButtonText: "OK",
          }).then(() => {
            location.reload();
          });
        })
        .catch((error) => {
          Swal.fire("Error!", "Could not delete book. Please try again!", "error");
        });
    }
  });
}

</script>
{% endblock %}
