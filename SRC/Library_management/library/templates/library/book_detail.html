{% extends "base.html" %}

{% block content %}
<section class="py-16 bg-gradient-to-br from-gray-50 via-gray-100 to-white min-h-screen">
  <div class="container mx-auto px-6 max-w-5xl">

    <!-- Back -->
    <a href="{% url 'librarian:managebook' %}"
       class="group inline-flex items-center text-indigo-600 hover:text-indigo-800 mb-8 font-semibold transition-all duration-300">
      <svg class="w-5 h-5 mr-2 group-hover:-translate-x-1 transition-transform duration-300"
           fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      Back to Book List
    </a>

    <!-- MAIN CARD -->
    <div class="bg-white/80 backdrop-blur-md p-10 rounded-3xl shadow-[0_8px_30px_rgba(0,0,0,0.05)]
                border border-gray-100 transition hover:shadow-[0_8px_40px_rgba(0,0,0,0.08)] duration-300">

      <!-- Header -->
      <header class="mb-8 pb-6 border-b border-gray-200 flex items-start gap-6">
        <div class="w-32 h-48 overflow-hidden rounded-2xl flex items-center justify-center shadow-lg flex-shrink-0">
          {% if book.cover_image %}
            <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="w-full h-full object-cover">
          {% else %}
            <div class="w-full h-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-6xl text-white">
              üìñ
            </div>
          {% endif %}
        </div>
        <div class="flex-1">
          <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight leading-snug">
            {{ book.title }}
          </h1>
          <p class="text-lg text-gray-600 mt-2 italic">
            Author:
            <span class="font-semibold text-indigo-700">{{ book.author }}</span>
          </p>
        </div>
      </header>

      <!-- Info -->
      <div class="grid md:grid-cols-2 gap-8 mt-8">
        <!-- Basic info -->
        <div class="space-y-4 text-gray-700">
          <h2 class="text-2xl font-bold text-indigo-700 border-b-2 border-indigo-100 pb-2 mb-4">
            üìò Basic Information
          </h2>

          <div class="space-y-3">
            <div class="flex justify-between border-b pb-2">
              <span class="font-medium">üè∑Ô∏è Category:</span>
              <span class="text-gray-900 font-semibold">{{ book.category|default:"‚Äî" }}</span>
            </div>

            <div class="flex justify-between border-b pb-2">
              <span class="font-medium">üìÖ Published Year:</span>
              <span class="font-semibold text-gray-900">{{ book.year|default:"‚Äî" }}</span>
            </div>

            <div class="flex justify-between border-b pb-2">
              <span class="font-medium">üì¶ In Stock:</span>
              <span class="font-extrabold text-2xl {% if book.quantity > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {{ book.quantity }} copies
              </span>
            </div>

            <div class="flex justify-between border-b pb-2">
              <span class="font-medium">üîó Book ID:</span>
              <span class="font-semibold text-gray-800">{{ book.book_id }}</span>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div>
          <h2 class="text-2xl font-bold text-indigo-600 border-b pb-2 mb-4">Description</h2>
          <div class="text-gray-700 leading-relaxed max-h-64 overflow-y-auto bg-gray-50 rounded-lg shadow-inner px-3 py-2 mt-2">
            {{ book.description|default:"This book currently has no detailed description."|striptags|linebreaksbr }}
          </div>
        </div>
      </div>

      <!-- Borrow Button -->
      <div class="mt-10 text-right">
        <button
          onclick="openBorrowModal('{{ book.book_id }}', '{{ book.title|escapejs }}', '{{ book.author|escapejs }}')"
          class="relative bg-gradient-to-r from-amber-500 to-orange-600 text-white px-8 py-3 rounded-xl
                 font-semibold shadow-md hover:shadow-lg hover:scale-105 transition-all duration-300
                 disabled:opacity-50 disabled:cursor-not-allowed"
          {% if book.quantity == 0 %}disabled{% endif %}
        >
          <span class="relative z-10">üìö Borrow Book Now</span>
          <div class="absolute inset-0 rounded-xl opacity-0 hover:opacity-100 transition
                      bg-gradient-to-r from-orange-400 to-yellow-500 blur-lg"></div>
        </button>
      </div>

      <!-- REVIEWS -->
      <div class="mt-12 bg-white p-8 rounded-2xl shadow-2xl border-t-4 border-yellow-500">
        <h2 class="text-3xl font-extrabold text-gray-900 border-b-2 border-yellow-100 pb-3 mb-6 flex items-center gap-3">
          <span>‚≠êÔ∏è Overall Rating:</span>
          <span class="text-yellow-600">
            {% if avg_rating %}{{ avg_rating|floatformat:1 }} / 5.0{% else %}No ratings{% endif %}
          </span>
          <span class="text-gray-500 text-base">({{ reviews|length }} reviews)</span>
        </h2>

        <!-- Review form -->
        <div class="bg-yellow-50 p-6 rounded-xl shadow-inner mb-8">
          <h3 class="text-xl font-bold text-yellow-700 mb-4">
            {% if user_review %}Edit Your Review{% else %}Submit Review{% endif %}
          </h3>

          {% if request.user.is_authenticated %}
            <form method="POST" class="space-y-4">
              {% csrf_token %}

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Rating:</label>
                <select name="rating" required
                        class="w-full md:w-1/2 px-3 py-2 border border-gray-300 rounded-lg shadow-sm
                               focus:ring-yellow-500 focus:border-yellow-500">
                  <option value="5" {% if user_review and user_review.rating == 5 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
                  <option value="4" {% if user_review and user_review.rating == 4 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê‚≠ê</option>
                  <option value="3" {% if user_review and user_review.rating == 3 %}selected{% endif %}>‚≠ê‚≠ê‚≠ê</option>
                  <option value="2" {% if user_review and user_review.rating == 2 %}selected{% endif %}>‚≠ê‚≠ê</option>
                  <option value="1" {% if user_review and user_review.rating == 1 %}selected{% endif %}>‚≠ê</option>
                </select>
              </div>

              <div>
                <label for="comment" class="block text-sm font-medium text-gray-700">Comment:</label>
                <textarea name="comment" id="comment" rows="4"
                          class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm
                                 focus:ring-yellow-500 focus:border-yellow-500 p-3"
                >{{ user_review.comment|default:"" }}</textarea>
              </div>

              <button type="submit"
                      class="bg-yellow-600 text-white px-6 py-2 rounded-lg font-semibold
                             hover:bg-yellow-700 transition duration-200 shadow-md">
                {% if user_review %}Update Review{% else %}Submit Review{% endif %}
              </button>
            </form>
          {% else %}
            <p class="text-lg text-red-600">
              Please <a href="{% url 'account:login' %}" class="font-bold underline">login</a> to submit a review.
            </p>
          {% endif %}
        </div>

        <!-- Other reviews -->
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Other Reviews</h3>

        <div class="space-y-6">
          {% for review in reviews %}
            <div class="border border-gray-200 p-5 rounded-xl shadow-md bg-white hover:shadow-lg transition-shadow">
              <div class="flex justify-between items-center mb-2">
                <p class="font-bold text-lg text-gray-900">
                  üë§ {{ review.user.username }}
                  {% if review.user == request.user %}
                    <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full ml-2">You</span>
                  {% endif %}
                </p>
                <div class="text-yellow-500 font-extrabold text-xl">
                  {{ review.get_rating_display }}
                </div>
              </div>

              <p class="text-gray-700 italic border-l-4 border-gray-200 pl-3">
                "{{ review.comment|default:"‚Äî No comment ‚Äî" }}"
              </p>

              <p class="text-xs text-gray-500 mt-2 text-right">
                Date: {{ review.created_at|date:"d/m/Y H:i" }}
              </p>
            </div>
          {% empty %}
            <p class="text-gray-500 italic py-5 text-center border-dashed border-2 border-gray-300 rounded-lg">
              No reviews yet for this book. Be the first!
            </p>
          {% endfor %}
        </div>
      </div>

      <!-- SIMILAR BOOKS (thu g·ªçn nh∆∞ ƒë√°nh gi√°) -->
      {% if similar_books %}
        <div class="mt-12 bg-white p-8 rounded-2xl shadow-2xl border-t-4 border-indigo-500">
          <div class="flex items-end justify-between mb-6">
            <div>
              <h2 class="text-3xl font-extrabold text-gray-900">üìö Similar Books</h2>
              <p class="text-gray-600 mt-1">
                Same category:
                <span class="font-semibold text-indigo-700">{{ book.category }}</span>
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            {% for b in similar_books %}
              <a href="{% url 'library:book_detail_view' b.pk %}"
                 class="group bg-white rounded-2xl border border-gray-100 shadow-md hover:shadow-xl
                        transition-all duration-300 overflow-hidden hover:-translate-y-1">

                <div class="h-48 overflow-hidden">
                  {% if b.cover_image %}
                    <img src="{{ b.cover_image.url }}" alt="{{ b.title }}" class="w-full h-full object-cover">
                  {% else %}
                    <div class="h-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center">
                      <span class="text-white text-3xl">üìö</span>
                    </div>
                  {% endif %}
                </div>

                <div class="p-5">
                  <h3 class="font-bold text-gray-900 text-lg leading-snug line-clamp-2 group-hover:text-indigo-700 transition">
                    {{ b.title }}
                  </h3>
                  <p class="text-gray-600 mt-1 line-clamp-1">Author: {{ b.author }}</p>

                  <div class="mt-4 flex items-center justify-between">
                    <span class="text-xs px-3 py-1 rounded-full bg-indigo-50 text-indigo-700 font-semibold">
                      {{ b.category }}
                    </span>

                    {% if b.quantity > 0 %}
                      <span class="text-xs px-3 py-1 rounded-full bg-green-50 text-green-700 font-semibold">
                        Available
                      </span>
                    {% else %}
                      <span class="text-xs px-3 py-1 rounded-full bg-red-50 text-red-700 font-semibold">
                        Out of Stock
                      </span>
                    {% endif %}
                  </div>
                </div>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}

    </div>
  </div>
</section>

<!-- Borrow Modal -->
<div id="borrowModal"
     class="fixed inset-0 bg-black/50 flex justify-center items-center hidden z-50">
  <div class="bg-white rounded-2xl p-6 w-[400px] shadow-2xl">
    <h2 class="text-2xl font-bold text-center mb-4 text-orange-600">Borrow Book üìö</h2>

    <div class="mb-4">
      <p id="bookTitle" class="font-semibold text-lg"></p>
      <p id="bookAuthor" class="text-gray-600"></p>
    </div>

    <form id="borrowForm" class="space-y-3">
      {% csrf_token %}

      <div>
        <label class="block font-medium">Borrow Date:</label>
        <input type="date" id="borrowDate"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
               required />
      </div>

      <div>
        <label class="block font-medium">Return Date:</label>
        <input type="date" id="returnDate"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-400"
               required />
      </div>

      <div>
        <label class="block text-gray-700 font-semibold">Quantity:</label>
        <input type="number" id="quantity" name="quantity" value="1" readonly
               class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed" />
      </div>

      <div class="flex justify-end space-x-3 mt-4">
        <button type="button" onclick="closeBorrowModal()"
                class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">
          Cancel
        </button>

        <button type="submit"
                class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all">
          Confirm
        </button>
      </div>
    </form>
  </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  let selectedBookId = null;

  function openBorrowModal(id, title, author) {
    selectedBookId = id;
    document.getElementById("bookTitle").textContent = `Book Title: ${title}`;
    document.getElementById("bookAuthor").textContent = `T√°c gi·∫£: ${author}`;

    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    const todayStr = `${yyyy}-${mm}-${dd}`;

    const borrowDateInput = document.getElementById("borrowDate");
    borrowDateInput.value = todayStr;
    borrowDateInput.min = todayStr;

    const returnDateInput = document.getElementById("returnDate");
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    const tomorrowStr = `${yyyy}-${mm}-${String(tomorrow.getDate()).padStart(2, "0")}`;
    returnDateInput.min = tomorrowStr;
    returnDateInput.value = tomorrowStr;

    document.getElementById("borrowModal").classList.remove("hidden");
  }

  function closeBorrowModal() {
    document.getElementById("borrowModal").classList.add("hidden");
  }

  document.getElementById("borrowForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const borrowDate = document.getElementById("borrowDate").value;
    const returnDate = document.getElementById("returnDate").value;
    const quantity = document.getElementById("quantity").value;

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    try {
      const response = await fetch("/library/borrow/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({
          book_id: selectedBookId,
          borrow_date: borrowDate,
          return_date: returnDate,
          quantity: quantity,
        }),
      });

      const data = await response.json();

      if (data.success) {
        Swal.fire({
          icon: "success",
          title: "Borrow book successfully!",
          text: "Your request has been recorded.",
          showConfirmButton: false,
          timer: 2000,
          timerProgressBar: true
        }).then(() => {
          closeBorrowModal();
          window.location.reload();
        });
      } else {
        Swal.fire({
          icon: "error",
          title: "Error!",
          text: data.message || "Cannot borrow book, please try again.",
          confirmButtonColor: "#d33",
        });
      }
    } catch (error) {
      Swal.fire({
        icon: "error",
        title: "Connection Error!",
        text: "Cannot connect to server. Please try again later.",
        confirmButtonColor: "#d33",
      });
    }
  });
</script>
{% endblock %}
