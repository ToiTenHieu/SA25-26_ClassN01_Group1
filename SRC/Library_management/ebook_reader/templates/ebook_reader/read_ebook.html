<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đang đọc: {{ book_title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* Custom scrollbar for a better look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #718096; /* gray-500 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a0aec0; /* gray-400 */
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-800 text-white h-screen flex flex-col overflow-hidden">

    <!-- Top Control Bar -->
    <header class="bg-gray-900 shadow-lg z-10 flex-shrink-0">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <!-- Book Title -->
            <div class="flex-1 min-w-0">
                <h1 class="text-lg font-bold truncate" title="{{ book_title }}">{{ book_title }}</h1>
            </div>

            <!-- Page Navigation -->
            <div class="flex items-center space-x-3">
                <button id="prev" class="p-2 rounded-full hover:bg-gray-700 transition-colors" title="Trang trước">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="flex items-center space-x-1 text-sm">
                    <span>Trang</span>
                    <input type="number" id="page_num_input" class="w-16 text-center bg-gray-700 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <span>/</span>
                    <span id="page_count">...</span>
                </div>
                <button id="next" class="p-2 rounded-full hover:bg-gray-700 transition-colors" title="Trang kế tiếp">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <!-- Zoom and Other Controls -->
            <div class="flex-1 flex justify-end items-center space-x-3">
                <button id="zoom_out" class="p-2 rounded-full hover:bg-gray-700 transition-colors" title="Thu nhỏ">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v6"></path></svg>
                </button>
                <button id="zoom_in" class="p-2 rounded-full hover:bg-gray-700 transition-colors" title="Phóng to">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7"></path></svg>
                </button>
                 <button id="fit_page" class="p-2 rounded-full hover:bg-gray-700 transition-colors" title="Vừa với trang">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1v4m0 0h-4m4 0l-5-5M4 16v4m0 0h4m-4 0l5-5m11 1v-4m0 0h-4m4 0l-5 5"></path></svg>
                </button>
                <button id="fullscreen" class="p-2 rounded-full hover:bg-gray-700 transition-colors" title="Toàn màn hình">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m16 0h-4M4 16v4m16 0h-4"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- PDF Viewer Area -->
    <main class="flex-1 overflow-auto custom-scrollbar py-8">
        <div id="loader-container" class="flex justify-center items-center h-full">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-gray-400">Đang tải sách...</p>
            </div>
        </div>
        <canvas id="pdf-viewer"></canvas>
    </main>

    <script>
        const url = '{{ ebook_url }}';
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        let pdfDoc = null,
            pageNum = 1,
            pageRendering = false,
            pageNumPending = null,
            scale = 1.5, // Default zoom level
            canvas = document.getElementById('pdf-viewer'),
            ctx = canvas.getContext('2d'),
            loader = document.getElementById('loader-container');

        function renderPage(num) {
            pageRendering = true;
            pdfDoc.getPage(num).then(function(page) {
                const scaledViewport = page.getViewport({ scale: scale });

                canvas.height = scaledViewport.height;
                canvas.width = scaledViewport.width;
                canvas.style.display = 'block';
                canvas.style.margin = '0 auto';
                canvas.style.boxShadow = '0 5px 15px rgba(0,0,0,0.3)';

                const renderContext = {
                    canvasContext: ctx,
                    viewport: scaledViewport
                };
                page.render(renderContext).promise.then(function() {
                    pageRendering = false;
                    if (pageNumPending !== null) {
                        renderPage(pageNumPending);
                        pageNumPending = null;
                    }
                });
            });
            document.getElementById('page_num_input').value = num;
        }

        function queueRenderPage(num) {
            if (pageRendering) pageNumPending = num;
            else renderPage(num);
        }

        function fitPage() {
            if (!pdfDoc) return;
            pdfDoc.getPage(pageNum).then(page => {
                const container = canvas.parentElement;
                const containerWidth = container.clientWidth - 1100; // padding
                const viewport = page.getViewport({ scale: 1 });
                scale = containerWidth / viewport.width;
                queueRenderPage(pageNum);
            });
        }

        // Event Listeners
        document.getElementById('prev').addEventListener('click', () => {
            if (pageNum <= 1) return;
            pageNum--;
            queueRenderPage(pageNum);
        });

        document.getElementById('next').addEventListener('click', () => {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            queueRenderPage(pageNum);
        });

        document.getElementById('page_num_input').addEventListener('change', (e) => {
            const num = parseInt(e.target.value);
            if (num > 0 && num <= pdfDoc.numPages) {
                pageNum = num;
                queueRenderPage(pageNum);
            } else {
                e.target.value = pageNum; // Reset to current page if invalid
            }
        });

        document.getElementById('zoom_in').addEventListener('click', () => {
            scale += 0.2;
            queueRenderPage(pageNum);
        });

        document.getElementById('zoom_out').addEventListener('click', () => {
            if (scale <= 0.4) return;
            scale -= 0.2;
            queueRenderPage(pageNum);
        });

        document.getElementById('fit_page').addEventListener('click', fitPage);

        document.getElementById('fullscreen').addEventListener('click', () => {
            const elem = document.documentElement;
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => {
                    alert(`Lỗi khi bật chế độ toàn màn hình: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        });

        // Initial Load
        (async function init() {
            try {
                pdfDoc = await pdfjsLib.getDocument(url).promise;
                loader.style.display = 'none'; // Hide loader
                document.getElementById('page_count').textContent = pdfDoc.numPages;
                fitPage(); // Initially fit page to width
            } catch (error) {
                console.error('Lỗi khi tải file PDF:', error);
                loader.innerHTML = `<p class="text-red-400">Không thể tải file PDF. Vui lòng kiểm tra lại đường dẫn hoặc file.</p>`;
            }
        })();

        // Resize event to refit the page
        window.addEventListener('resize', () => {
            if (pdfDoc) {
                fitPage();
            }
        });
    </script>
</body>
</html>